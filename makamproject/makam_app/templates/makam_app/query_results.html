{% extends "base.html" %}

{% block title %}
Arama Sonuçları
{% endblock title %}

{% block content %}

<form class="form-group" enctype="multipart/form-data" method="post" id="my_data_form">

    <div class="container">

        <div class="row">

            <div class="col-8">

                <h3>Sonuçlardan Seç:</h3>

                <ul id="my_pieces_list">

                    {% for pieces in pieces_found %}

                    <li style="margin-bottom: 5px;" id="{{pieces.id}}">

                        <div class="row">

                            <div class="col-10">

                                <div class="row">

                                    <div class="col-6">
                                        Eser Adı: {{pieces.eser_adi}}
                                        <br>
                                        Bestekar: {{pieces.bestekar}}
                                    </div>
                                    
                                    <div class="col-6">
                                        {% for subcomponent in pieces.subcomponents %}

                                            Form İsmi: {{subcomponent.subcomponent_isim}}
                                            <br>

                                            <hr>

                                            {% for key, value in subcomponent.items %}

                                                {% if key == 'cesni' %}

                                                    {% for cesni_element in value %}

                                                        {% for cesni_property_name, cesni_property_value in cesni_element.items %}

                                                            {{cesni_property_name}} : {{cesni_property_value}}
                                                            <br>

                                                        {% endfor %}

                                                        <hr>
                                                    {% endfor %}

                                                {% endif %}

                                            {% endfor %}

                                    {% endfor %}
                                    </div>

                                </div>

                            </div>

                            <div class="col-1">
                                <button type="button" onclick="addPieceToAnalysis(this)"
                                    class="btn btn-outline-primary"><b>E</b></button>
                            </div>

                            <div class="col-1">
                                <button type="button" onclick="removePieceFromAnalysis(this)"
                                    class="btn btn-outline-danger"><b>X</b></button>
                            </div>

                        </div>

                        <hr>

                    </li>

                    {% endfor %}

                </ul>

            </div>
            <div class="col-4">

                <ul id="my_selected_pieces_list"></ul>

            </div>

        </div>

    </div>

    <input type="submit" value="Analiz Et" id="submit_all">

</form>

{% endblock content %}

{% block scripts %}
<script type="text/javascript">

    var selected_piece_pks = [];
    var selected_piece_list = document.getElementById("my_selected_pieces_list");

    function addPieceToAnalysis(elem) {

        let selected_piece_id = elem.parentNode.parentNode.parentNode.id;

        if (!selected_piece_pks.includes(selected_piece_id)) {

            selected_piece_pks.push(selected_piece_id);

            elem.parentNode.parentNode.style.backgroundColor = '#ccffcc';
        }

        console.log(selected_piece_pks)
    }

    function removePieceFromAnalysis(elem) {

        let selected_piece_id = elem.parentNode.parentNode.parentNode.id;

        if (selected_piece_pks.includes(selected_piece_id)) {

            selected_piece_pks.pop(selected_piece_id);

            elem.parentNode.parentNode.style.backgroundColor = 'white';
        }

        console.log(selected_piece_pks)
    }

    $('#submit_all').click(function (event) {

        event.preventDefault();

        $.ajax({
            type: 'POST',
            url: "{% url 'makam_app:QueryResultsView' %}",
            dataType: 'json',
            data: {
                csrfmiddlewaretoken: '{{ csrf_token }}',
                selected_pieces: JSON.stringify(selected_piece_pks),
            },
            success: function (data) {
                alert("Sonuçlar alınıyor.")
                window.location.href = data.url;
            },
            error: function (data) {
                alert("Parça seçilmedi.")
            }
        });

    });

</script>
{% endblock scripts %}